---
title: "Mapping Crimean-Congo Haemorrhagic Fever in Africa with BART"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

suppressMessages(library(tidyverse))
options(digits=2)
```

# Getting Started

So you're interested in using \texttt{embarcadero} to do species distribution modeling with Bayesian additive regression trees! That's great. BARTs are a powerful way to do machine learning and, while not a new method per se, they are very new for SDMs. 

In this advanced tutorial, I'm going to assume that you've seen the main paper and the `embarcadero` package vignette, which goes over basic functions and some of the internal structure of BART models. This tutorial, and the associated repo (`cjcarlson/pier39`), are intended for advanced users interested in seeing what a professional workflow might look like for an applied use.


```{r setup, echo=FALSE, message=FALSE}
library(embarcadero)
set.seed(12345)
```

```{r, eval=FALSE}
library(embarcadero)
set.seed(12345)
```

Our goal here is to do a few things:

1. Build a species distribution model for _Hyalomma truncatum_, a tick we think might be a vector of Crimean-Congo haemorrhagic fever (CCHF) in Africa.
2. To build a transmission risk map, again using species distribution modeling/ecological niche modeling, for CCHF in Africa. 
3. To see if we learn anything from that model about CCHF we didn't know before.
4. To see some of the advanced visualization and workflow tricks in the `embarcadero` package!

# Mapping Hyalomma

We're going to make a suitability layer for _Hyalomma truncatum_, a possible CCHF vector. The tick occurrence data, which is a set of presence points, comes from Cumming et al. (1998) _Bulletin of Entomological Research_, one of the most detailed datasets in the world on parasite distributions. We're going to build a species distribution model using those points, some climate data, and a few other convenient layers that might be relevant.

## Data entry

Let's start by loading in the climate data. We'll use three main sources:

1. WorldClim v1.4 (Hijmans et al. 2005), a harmonized dataset of bioclimatic variables mostly used for species distribution modeling 
2. Two layers describing long-term averages of the normalized difference vegetation index (NDVI), which captures the greenness of a landscape (taken from previous use in Carlson et al. 2018). This can be an important variable for measuring invertebrate distributions, for example, or partitioning landscapes into different biomes.
3. A layer produced by the NASA SEDAC center describing the percent cropland by grid cell. If we think ruminants are spreading CCHF, this might matter! (https://sedac.ciesin.columbia.edu/data/set/aglands-croplands-2000)

Based on some expert opinion, I picked a handful of variables I thought might work well (and it's already reduced down to minimize redunandancy): 

* BIO1: Mean annual temperature
* BIO2: Mean diurnal range
* BIO5: Max temperature of warmest month
* BIO6: Min temperature of coldest month
* BIO12: Mean annual precipitation
* BIO13: Precipitation of wettest month
* BIO14: Precipitation of driest month
* BIO15: Precipitation seasonality
* Mean NDVI (normalized difference vegetation index)
* NDVI amplitude
* Percent cropland by pixel

Let's read in the covariates. 

```{r}
load(file = "~/Github/pier39/covsraw.rda"); covs <- covsraw
class(covs)
covs@crs <- crs('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0')
```

This is an *incredibly* granular dataset, which means BART is going to predict a little slowly. (Other packages for BART models have faster predictions, but less functionality for other things, so I chose functionality at the expense of speed; hopefully future versions will build on this.) We can work around this a little by aggregating the RasterStack; because this comes up a lot, there's a function `bigstack` in `embarcadero` to do this:

```{r}
cov.big <- bigstack(covs, by=10, quiet = TRUE)
dim(covs)
dim(cov.big)
```

Next, let's load in our tick occurrence dataset, which is a set of longitude/latitude coordinates. 

```{r}
load(file = "~/Github/pier39/ticks.rda")
head(ticks)
nrow(ticks)
```

Presence points are usually a little aggregated in space, so as a normal data cleaning practice, I like to thin my occurrence data to one point per raster grid cell.

```{r}
# Make a spatial point data frame
mod <- SpatialPointsDataFrame(ticks[,3:4],data.frame(ticks[,1]))
names(mod@data) <- 'Presence'
nrow(mod)

# Rasterizing and converting back to points makes one unique point per grid cell
tmp=rasterize(mod, covs[[1]], field="Presence", fun="min")
pts.sp1=rasterToPoints(tmp, fun=function(x){x>0})
nrow(pts.sp1)

# Extract the climate data at each point 
pres.cov <- raster::extract(covs, pts.sp1[,1:2])
head(pres.cov)
```

Next, let's generate an equal number of pseudoabsences around Africa to the number of presences we have. BARTs are like BRTs in that they are sensitive to assumed prevalence; anecdotally, I strongly suggest using an equal number of presences and absences in your training data. You can experiment with the demo data by changing "nrow(ticks)" to "5000" below if you want to see some weirder model behavior. 

```{r}
#Generate the data
absence <- randomPoints(covs,nrow(ticks)) 
abs.cov <- raster::extract(covs, absence)

#Code the response
pres.cov <- data.frame(pres.cov); pres.cov$tick <- 1
abs.cov <- data.frame(abs.cov); abs.cov$tick <- 0

# And one to bind them
all.cov <- rbind(pres.cov, abs.cov)
head(all.cov)

# Let's just clean it up a little bit - remove any missing data
all.cov <- all.cov[complete.cases(all.cov),]
```

Now we have a dataset ready to do some modeling!

## Running models with dbarts

We could try something really simple on defaults, right out the gate. The \texttt{bart} function in \texttt{dbarts} can just be run on defaults:

```{r}
xvars <- names(all.cov)[!(names(all.cov)=='tick')]
xvars
first.model <- bart(all.cov[,xvars], all.cov[,'tick'], keeptrees=TRUE)
```

In reality, we know we want to do variable set reduction, and tune the model a bit from there. In the main vignette you can see the different component parts of that process. Here, we're going to use our most powerful shortcut: `bart.step`. Inside `bart.step`, five things happen:

1. The variable importance diagnostic from `varimp.diag` is generated
2. The stepwise variable set reduction in `variable.step` is run
3. The final model is run with the reduced predictor set
4. The variable importance plot from `varimp` is generated
5. The model summary from `summary` is returned

This is slow but very easy to simply fire off if you're running a large workflow. Let's do it:

```{r}
sdm <- bart.step(xdata = all.cov[,xvars], 
                 ydata = all.cov[,'tick'], 
                 full = TRUE)
```

Out of all the variables, "crop" seems to be especially undesirable as a predictor. A few other variables seem like they might not be helping the model either, but we probably need a systematic way to deal with that.

A high AUC value indicates our model performs well. The AUC function also returns an optimal threshold that maximizes the true skill statistic (TSS), and the sensitivity/specificity of the model at that cutoff (alpha).

What do the predictions look like? To make a predicted raster, we have to use \texttt{embarcadero}'s wrapper for the native \texttt{predict} function in \texttt{dbarts}. 

```{r, fig.fullwidth=TRUE}

# Do the spatial prediction
hytr.layer <- predict(model = sdm,
                      inputstack = covs)

# How's it look?
plot(hytr.layer, main='Hyalomma truncatum')

# Check that against the presence data:
points(SpatialPoints(ticks[,c('Longitude.X','Latitude.Y')]), 
        pch=16, cex=0.2)

```

This model seems okay. We're getting predictions in places we don't have any records, like North Africa. That could be good if we think that's suitable climatic space (and if you know _Hyalomma_, you know there's definitely some species there, though posibly not truncatum), but with much of the inhabited area not being predicted, let's revisit that later.

# Mapping CCHF

Alright. Now let's get back to business by building the CCHF map. We're going to use the same predictors as we used for _H. truncatum_, plus the suitability layer for the ticks. (Using one SDM layer in another map is a sort of finnicky business - sometimes it improves predictions and is epistemologically valid, other times it predetermines a certain outcome in the final model, given issues with colinearity. That's a broader discussion than what we're doing here! If the final map predicts some areas that aren't where the ticks are, I'll call that a win. If they were identical, I would worry.)

## Running the CCHF model

This time, let's just do the variable selection up front. Same plan as before:

```{r}

# Update the covariate stack
covs <- stack(covs, hytr.layer)
names(covs)[12]='hytr' # for Hyalomma truncatum
xvars <- c(xvars, 'hytr')

# Read in the data
load(file = "~/Github/pier39/cchf.rda")
head(cchf)
nrow(cchf)

# Spatial thinning checks; this also limits it to African points (CCHF is found elsewhere in the world too, and our data includes other records!)
cchf <- cchf[,c('LONGITUDE','LATITUDE')]; cchf$Presence = 1
cchf <- SpatialPointsDataFrame(cchf[,1:2],data.frame(Presence=cchf[,3]))
tmp=rasterize(cchf, covs[[1]], field="Presence", fun="min")
pts.sp1=rasterToPoints(tmp, fun=function(x){x>0})
nrow(pts.sp1)

# Extract presence values
pres.cov <- raster::extract(covs, pts.sp1[,1:2])
pres.cov <- na.omit(pres.cov)
head(pres.cov)

#Generate pseudoabsences
absence <- randomPoints(covs,nrow(pres.cov)) 
abs.cov <- raster::extract(covs, absence)

#Code the response
pres.cov <- data.frame(pres.cov); pres.cov$cchf <- 1
abs.cov <- data.frame(abs.cov); abs.cov$cchf <- 0

# And one to bind them
all.cov <- rbind(pres.cov, abs.cov)
all.cov <- all.cov[complete.cases(all.cov),]; nrow(all.cov)
head(all.cov)

# This part automates the variable selection and returns the model

cchf.model <- bart.step(xdata = all.cov[,xvars], 
                        ydata = all.cov[,'cchf'], 
                        full = TRUE)

# Do the spatial prediction
cchf.map <- predict(model = cchf.model,
                    inputstack = covs)

# How's it look?
plot(cchf.map, main='CCHF')
points(pts.sp1, col='black', pch=16)

```

OK. Nice model! Let's see what we can do to unpack it.

First, let's compare it against the tick map.

```{r}
par(mfrow=c(1,2))
plot(hytr.layer, main='H. truncatum')
plot(cchf.map, main='CCHF')
```

Our model seems to be different from the previous one (published by Messina _et al._, using this dataset which they generously provide online) in three major ways. 

First, using the tick vector has increased the amount of predicted suitable area in South Africa, Namibia, Botswana, and Zimbabwe. That makes sense, overall--if there are vectors present, CCHF seems plausible.

Second, the model predicts the area in coastal Cameroon, Gabon, and Equatorial Guinea that we know has some CCHF records but has previously been underpredicted. Weirdly, we don't have good evidence _Hyalomma truncatum_ is there. So, the model is doing well, but the ecology is still unclear.

Finally, the northern coast of Africa is predicted to be highly suitable. There's plenty of _Hyalomma_ species up there, though not _H. truncatum_ as far as our data suggests. It's possible we should think more about the possibility of CCHF in Morocco and Algeria.

## Visualizing uncertainty

One of the best things about BARTs is that by default the outputs are posteriors, with built-in uncertainty. That's the great thing about Bayesian statistics!

This is going to be, by default, the slowest part of this process. 

```{r}

cchf.map <- bart.map(model = cchf.model,
                     inputstack = covs,
                     ci=TRUE)
```

When you run this argument with "ci=TRUE" it samples a 5\% and 95\% draw to give you a 90\% credible interval on that posterior. The difference between them--the posterior width in a given pixel--is a pretty good spatial measure of uncertainty. This is the main level of uncertainty people tend to report when they do studies like this, so I'm not feeling a lot of pressure to add more functionality here. But if people want it, I'll add something to pull arbitrary levels from the posterior. (It's also worth noting that the credible intervals in the partial dependence plots come from a similar approach, though I am not in fact completely sure the bounds are a 95\% CI.)

## Analytics

Finally, let's unpack some of what's under the hood in the model. First let's look at the variable contributions:

```{r}
varimp(cchf.model, plots=TRUE)
```

NDVI amplitude and the tick vector come out on top; bio1 and mean NDVI also contribute a lot. Let's look at the response functions a little bit. First, let's look at the partial dependence plots for a couple individual variables. (One downside of the BART native plots is (1) they're a bit janky looking and (2) they just spit out a lot of text. That's why the objects are being saved to "p". But I wrote a wrapper that uses what pdbart spits out and ggplot2 to save you the trouble of thinking through dataviz on this one thing.)

```{r}
# Let's do one variable
p <- pdbart(cchf.model, xind=hytr, pl=TRUE)

# That's not very pretty. Let's use embarcadero's version, which allows multiple ways of visualizing the posterior
partial(cchf.model, 'hytr', trace=FALSE, ci=TRUE, equal=FALSE)

# Hm.... that's a little better. Let's up the smooth (this ISN'T a smoother - it just takes more points to fit the curve) and make the spacing equal.
partial(cchf.model, 'hytr', trace=TRUE, ci=FALSE, equal=TRUE, smooth=10)

# Let's do a couple at once
partial(cchf.model, x.vars=c('bio12','bio13'), trace=FALSE, ci=TRUE, panel=TRUE, smooth=5)
```

Some of these patterns are pretty clear - suitability declines above 20 degrees C, and increases with the probability of the tick. NDVI is a little less intuitive to the human mind, but a great feature of BART is that we can pretty easily do two-dimensional partial dependence plots, and we can pretty easily visualize the optimum (I haven't added a wrapper for this yet):

```{r}
p <- pd2bart(cchf.model, xind=c('ndvi.mean', 'ndvi.amp'), pl=TRUE)
```

This is probably my favorite feature of \texttt{dbarts} - these plots are a really nice way to visualize the Hutchinsonian niche sort of like how NicheA does, but within the familiar framework of classification trees. Plus it's not just a cross-product of the individual partials - the BART framework allows for interactions and sometimes you'll see them show up in these plots.

One last cool trick....


# These are some figures we can use in the main paper

```{r}
par(mfrow=c(1,1))
partial(cchf.model, 'bio12', trace=TRUE, ci=FALSE, equal=TRUE, smooth=10)
p <- pd2bart(cchf.model, xind=c('ndvi.mean', 'ndvi.amp'), pl=TRUE)

spartial(cchf.model, covs, x.vars = 'bio2', equal=TRUE)

par(mfrow=c(1,3), mar=c(0,0,4,4))
plot(hytr.layer, box=FALSE, axes=FALSE)
plot(cchf.map$mean, box=FALSE, axes=FALSE)
plot(cchf.map$upper.ci - cchf.map$lower.ci, box=FALSE, axes=FALSE)
```


# Finally...

That's all the functionality I've outlined so far. I'll keep building out the visualizations to make them more consistent and publication-ready for people, and am also eager to work with other people on this.

Finally, a big thanks to Jane Messina _et al._ for sharing their CCHF data, and to Graeme Cumming for tick data.

# References

* Carlson, C.J., _et al._ "The global distribution of Bacillus anthracis and associated anthrax risk to humans, livestock and wildlife." Nature Microbiology (2019): _in press_.
* Cumming, G. S. "Host preference in African ticks (Acari: Ixodida): a quantitative data set." _Bulletin of Entomological Research_ 88.4 (1998): 379-406.
* Hijmans, R.J., _et al._ "Very high resolution interpolated climate surfaces for global land areas." _International Journal of Climatology: A Journal of the Royal Meteorological Society_ 25.15 (2005): 1965-1978.
* Messina, Jane P., _et al._ "A global compendium of human Crimean-Congo haemorrhagic fever virus occurrence." _Scientific Data_ 2 (2015): 150016.
* Messina, Jane P., _et al._ "The global distribution of Crimean-Congo hemorrhagic fever." _Transactions of the Royal Society of Tropical Medicine and Hygiene_ 109.8 (2015): 503-513.
