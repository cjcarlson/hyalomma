---
title: "Mapping Crimean-Congo Haemorrhagic Fever in Africa with BART"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

suppressMessages(library(tidyverse))
```

# Getting Started

So you're interested in using \texttt{embarcadero} to do species distribution modeling with Bayesian additive regression trees! That's great. BARTs are a powerful way to do machine learning and, while not a new method per se, they are very new for SDMs. 

In this advanced tutorial, I'm going to assume that you've seen the main paper and the `embarcadero` package vignette, which goes over basic functions and some of the internal structure of BART models. This tutorial, and the associated repo (`cjcarlson/pier39`), are intended for advanced users interested in seeing what a professional workflow might look like for an applied use.


```{r setup, echo=FALSE, message=FALSE}
library(embarcadero)
set.seed(12345)
```

```{r, eval=FALSE}
library(embarcadero)
set.seed(12345)
```

Our goal here is to do a few things:

1. Build a species distribution model for _Hyalomma truncatum_, a tick we think might be a vector of Crimean-Congo haemorrhagic fever (CCHF) in Africa.
2. To build a transmission risk map, again using species distribution modeling/ecological niche modeling, for CCHF in Africa. 
3. To see if we learn anything from that model about CCHF we didn't know before.
4. To see some of the advanced visualization and workflow tricks in the `embarcadero` package!

# Mapping Hyalomma

We're going to make a suitability layer for _Hyalomma truncatum_, a possible CCHF vector. The tick occurrence data, which is a set of presence points, comes from Cumming et al. (1998) _Bulletin of Entomological Research_, one of the most detailed datasets in the world on parasite distributions. We're going to build a species distribution model using those points, some climate data, and a few other convenient layers that might be relevant.

## Data entry

Let's start by loading in the climate data. We'll use three main sources:

1. WorldClim v1.4 (Hijmans et al. 2005), a harmonized dataset of bioclimatic variables mostly used for species distribution modeling 
2. Two layers describing long-term averages of the normalized difference vegetation index (NDVI), which captures the greenness of a landscape (taken from previous use in Carlson et al. 2018). This can be an important variable for measuring invertebrate distributions, for example, or partitioning landscapes into different biomes.
3. A layer produced by the NASA SEDAC center describing the percent cropland by grid cell. If we think ruminants are spreading CCHF, this might matter! (https://sedac.ciesin.columbia.edu/data/set/aglands-croplands-2000)

Based on some expert opinion, I picked a handful of variables I thought might work well (and it's already reduced down to minimize redunandancy): 

* BIO1: Mean annual temperature
* BIO2: Mean diurnal range
* BIO5: Max temperature of warmest month
* BIO6: Min temperature of coldest month
* BIO12: Mean annual precipitation
* BIO13: Precipitation of wettest month
* BIO14: Precipitation of driest month
* BIO15: Precipitation seasonality
* Mean NDVI (normalized difference vegetation index)
* NDVI amplitude
* Percent cropland by pixel

Let's read in the covariates. 

```{r}
load(file = "~/Github/pier39/covsraw.rda"); covs <- covsraw
class(covs)
covs@crs <- crs('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0')
```

This is an *incredibly* granular dataset, which means BART is going to predict a little slowly. (Other packages for BART models have faster predictions, but less functionality for other things, so I chose functionality at the expense of speed; hopefully future versions will build on this.) We can work around this a little by aggregating the RasterStack; because this comes up a lot, there's a function `bigstack` in `embarcadero` to do this:

```{r}
cov.big <- bigstack(covs, 10)
```
